--- otftotfm.cc.orig	Mon Jan 31 14:35:21 2005
+++ otftotfm.cc	Mon Jan 31 12:04:29 2005
@@ -87,6 +87,7 @@
 #define DEFAULT_LIGKERN_OPT	329
 #define NO_ECOMMAND_OPT		330
 #define LETTER_FEATURE_OPT	331
+#define FILTER_OPT		332
 
 #define AUTOMATIC_OPT		341
 #define FONT_NAME_OPT		342
@@ -125,6 +126,7 @@
     { "feature", 'f', FEATURE_OPT, Clp_ArgString, 0 },
     { "letter-feature", 0, LETTER_FEATURE_OPT, Clp_ArgString, 0 },
     { "lf", 0, LETTER_FEATURE_OPT, Clp_ArgString, 0 },
+    { "filter", 0, FILTER_OPT, Clp_ArgString, 0 },
     { "encoding", 'e', ENCODING_OPT, Clp_ArgString, 0 },
     { "literal-encoding", 0, LITERAL_ENCODING_OPT, Clp_ArgString, 0 },
     { "extend", 'E', EXTEND_OPT, Clp_ArgDouble, 0 },
@@ -260,6 +262,8 @@
   -s, --script=SCRIPT[.LANG]   Use features for script SCRIPT[.LANG] [latn].\n\
   -f, --feature=FEAT           Activate feature FEAT.\n\
   --lf, --letter-feature=FEAT  Activate feature FEAT for letters.\n\
+      --filter=PROP            Restrict the following features to symbols\n\
+                               having property PROP.\n\
   -E, --extend=F               Widen characters by a factor of F.\n\
   -S, --slant=AMT              Oblique characters by AMT, generally <<1.\n\
   -L, --letterspacing=AMT      Letterspace each character by AMT units.\n\
@@ -962,9 +966,9 @@
 
     StringAccum command;
     if (vpl)
-	command << "vptovf " << pl_filename << ' ' << vf_filename << ' ' << tfm_filename;
+	command << "vptovf " << pl_filename << ' ' << vf_filename << ' ' << tfm_filename << " >&2";
     else
-	command << "pltotf " << pl_filename << ' ' << tfm_filename;
+	command << "pltotf " << pl_filename << ' ' << tfm_filename << " >&2";
     
     int status = mysystem(command.c_str(), errh);
 
@@ -1434,7 +1438,7 @@
     Vector<String> unicoding;
     bool no_ecommand = false, default_ligkern = false;
     String codingscheme;
-
+    GlyphFilter* current_gf = NULL;
     GlyphFilter current_alternate_filter;
     GlyphFilter* current_alternate_filter_ptr = &null_filter;
     
@@ -1461,6 +1465,12 @@
 	      break;
 	  }
 
+          case FILTER_OPT: {
+              current_gf = new GlyphFilter;
+              current_gf->add_substitution_filter(clp->arg, false, errh);
+              break;
+          }
+
 	  case FEATURE_OPT: {
 	      OpenType::Tag t(clp->arg);
 	      if (!t.valid())
@@ -1471,7 +1481,13 @@
 		  if (!current_alternate_filter_ptr)
 		      current_alternate_filter_ptr = new GlyphFilter(current_alternate_filter);
 		  interesting_features.push_back(t);
-		  feature_filters.insert(t, current_alternate_filter_ptr);
+                  if (current_gf) {
+                    GlyphFilter *gf = new GlyphFilter(*current_gf);
+                    *gf += *current_alternate_filter_ptr;
+		    feature_filters.insert(t, gf);
+                  }
+                  else
+       		    feature_filters.insert(t, current_alternate_filter_ptr);
 	      }
 	      break;
 	  }

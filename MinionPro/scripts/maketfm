#!/bin/bash

# parse options

font="$1"

shift

usage() {
  exec >&2
  echo "USAGE: maketfm <font> [options]"
  echo -e "\nSupported options are:"
  echo "--verbose      | --quiet"
  echo "--smallcaps    | --nosmallcaps"
  echo "--swash        | --noswash"
  echo "--greek        | --nogreek"
  echo "--cyrillic     | --nocyrillic"
  echo "--vietnamese   | --novietnamese"
  echo "--kern         | --nokern"
  echo "--wide-spacing | --narrow-spacing"
  echo "--expanded     | --noexpanded"
  echo "--pack=<glyph list>"
  exit 1
}

if [[ $font == "" || $font == "-"* ]]
then
  echo -e "No font specified!\n"
  usage
fi

verbose=false
create_greek=true
create_cyrillic=true
create_vietnamese=true
create_expanded=false
create_kerned=true
create_smallcaps=true
create_sc_grekcyrl=false
create_swash=true
wide_spacing=false
glyph_list=""

if ! otfinfo -f otf/$font-Regular.otf | grep -q smcp
then 
  create_smallcaps=false
fi

if ! otfinfo -f otf/$font-It.otf | grep -q Swash
then 
  create_swash=false
fi

for opt in "$@"
do
  case $opt in
    --verbose)        verbose=true;;
    --quiet)          verbose=false;;
    --greek)          create_greek=true;;
    --nogreek)        create_greek=false;;
    --smallcaps)      create_smallcaps=true;;
    --nosmallcaps)    create_smallcaps=false;;
    --swash)          create_swash=true;;
    --noswash)        create_swash=false;;
    --cyrillic)       create_cyrillic=true;;
    --nocyrillic)     create_cyrillic=false;;
    --vietnamese)     create_vietnamese=true;;
    --novietnamese)   create_vietnamese=false;;
    --expanded)       create_expanded=true;;
    --noexpanded)     create_expanded=false;;
    --kern)           create_kerned=true;;
    --nokern)         create_kerned=false;;
    --wide-spacing)   wide_spacing=true;;
    --narrow-spacing) wide_spacing=false;;
    --pack=*)         glyph_list="${opt#--pack=}";;
    --pack)           echo -e "Option --pack is missing an argument\n";
                      usage;;
    *)                echo -e "Unknown option $opt\n";
                      usage;;
  esac
done

# expanded metrics for pdftex's font expansion
if $create_expanded; then
  expansions="-20 -16 -12 -8 -4 0 4 8 12 16 20"
else
  expansions="0"
fi

noliga="--unicoding='ff =: emptyslot'"
noliga="$noliga --unicoding='fi =: emptyslot'"
noliga="$noliga --unicoding='fl =: emptyslot'"
noliga="$noliga --unicoding='ffi =: emptyslot'"
noliga="$noliga --unicoding='ffl =: emptyslot'"

dir_flags="--tfm-directory=./tfm --vf-directory=./vf --encoding-directory=./dvips --type1-directory=./pfb"
extra_flags=""
oml_flags=""
greek_flags=""
quote_flags=""

if [ -e "scripts/maketfm-$font.cfg" ]
then
  . "scripts/maketfm-$font.cfg"
fi

# check utilities

otftotfm_version() {
  otftotfm --version | sed -n -e 's/^otftotfm .* \([0-9.]\+\)$/\1/p'
}

requires_otftotfm_version() {
  local min=$1 status=0
  local ver=$(otftotfm_version)
  if (( $(bc <<< "${ver:-0} < $min") )); then
    echo "You need otftotfm version $min or greater to run this script." >&2
    exit 1
  fi
}

requires_otftotfm_version 2.58


# output progress message later while the scripts run
progress() {
  local scripts=
  while [[ $1 == "-o" ]]; do
    scripts="$scripts $2"
    shift 2
  done
  if [[ -z $scripts ]]; then
    scripts="maketfm.tmp"
    if $create_expanded; then
      scripts="$scripts maketfm-expanded.tmp"
    fi
  fi
  local s
  for s in $scripts; do
    echo "echo $(printf "%q " "$@") >&2" >>"$s"
  done
}

make_base_encodings() {

  if [[ $glyph_list != "" ]]
  then
    local i b enc

    split -l 256 "$glyph_list" glyph-list-

    for b in glyph-list-*
    do
      i=${b#glyph-list-}

      enc="dvips/base-$font-$i.enc"

      echo "/$font-Base-$i [" >$enc
      echo `cat glyph-list-$i` `wc glyph-list-$i | awk '{for (x=1;x<=256-$1;x++) printf("/.notdef\n")}'` | sed s/" "/"\n"/g | awk '{i+=1;printf("%s ",$1)} i==8 {i=0;printf("\n")}' | awk '(NR-1)%2!=1 {printf("%% 0x%2.2X\n",(NR-1)*8)} {print "  "$0}' >> $enc
      echo "] def" >>$enc
    done
    rm glyph-list-*
  fi
}

make_enckern() {

  if [ -e "pfb/$font-$1.pfb" ]
  then
    local e

    for e in enc/mn-*.enc
    do
      local enc=$(basename $e .enc)
      enc=${enc#mn-}

      for l in "" "-l1" "-l2"
      do
        if $create_kerned
        then
          if [ -e "kerning/$1$l-$enc.kern" ]
          then
            cat $e "kerning/$1$l-$enc.kern" | grep -v "#" >enc/mn-$1$l-$enc.enckern
          elif [ -e "kerning/$1$l.kern" ]
          then
            cat $e "kerning/$1$l.kern" | grep -v "#" >enc/mn-$1$l-$enc.enckern
          elif [ -e "kerning/$1-$enc.kern" ]
          then
            cat $e "kerning/$1-$enc.kern" | grep -v "#" >enc/mn-$1$l-$enc.enckern
          elif [ -e "kerning/$1.kern" ]
          then
            cat $e "kerning/$1.kern" | grep -v "#" >enc/mn-$1$l-$enc.enckern
          else
            cp $e enc/mn-$1$l-$enc.enckern
          fi
          if [[ $enc = "integral" ]]
          then
            cp $e enc/mn-$1$l-$enc.enckern
          fi
        else
          cp $e enc/mn-$1$l-$enc.enckern
        fi
      done
    done
  fi
}

get_kern_file() {
  case $3 in
    *-l2-*) kernfile=enc/mn-$1-l2-$2.enckern;;
    *-l1-*) kernfile=enc/mn-$1-l1-$2.enckern;;
    *)      kernfile=enc/mn-$1-$2.enckern;;
  esac
}

get_exp_info() {
  local exp=$1
  if (( exp == 0 )); then
    exp_suffix=
    exp_flag=
  else
    exp_suffix=$(printf "%+d" "$exp")
    exp_flag=-E$(bc <<< "scale=3; 1+$exp/1000")
  fi
}

make_base_fonts() {

  if [[ $glyph_list != "" ]]
  then
    local name="$1"
    local e i

    local exp exp_flag exp_suffix
    for exp in $expansions; do
      get_exp_info "$exp"

      local base_font_list="base-fonts-$font-$name$exp_suffix"
      local tex_prefix="$font-$name"

      echo -n >$base_font_list

      otftotfm $exp_flag $dir_flags --no-type1 --no-updmap -e enc/mn-ot1.enc "otf/$font-$name.otf" "$tex_prefix$exp_suffix" | grep -- --lcdfj
      rm ./tfm/"${tex_prefix}--base${exp_suffix}".tfm \
        ./tfm/"${tex_prefix}${exp_suffix}".tfm \
        ./vf/"${tex_prefix}${exp_suffix}".vf ./dvips/a_*.enc
      echo "$tex_prefix--lcdfj$exp_suffix - dotlessj" >>$base_font_list

      for e in dvips/base-$font-*.enc
      do
        i=${e#dvips/base-$font-}
        i=${i%.enc}
        local texname="$font-$name-Base-$i$exp_suffix"

        otftotfm $exp_flag $dir_flags --no-type1 --no-updmap --no-dotlessj --literal-encoding="$e" "otf/$font-$name.otf" "$texname"

        echo "$texname $e" >>$base_font_list

      done
    done
  fi
}

make_tfm() {

  local name="$1"
  local enc="$2"
  local spec="$3"
  shift 3

  local common_flags="$dir_flags --no-type1 --no-updmap --warn-missing -fkern"

  if ! $verbose
  then
    common_flags="-q $common_flags"
  fi

  local kernfile
  get_kern_file "$name" "$enc" "$spec"

  progress -n " $spec,"

  local exp
  for exp in $expansions; do
    local exp_suffix exp_flag script_file
    get_exp_info "$exp"
    if (( exp == 0 )); then
      script_file=maketfm.tmp
    else
      script_file=maketfm-expanded.tmp
    fi

    local base_encoding_flags=""
    if [[ $glyph_list != "" && $enc != "integral" ]] 
    then
      base_encoding_flags="--base-encodings='base-fonts-$font-$name$exp_suffix'"
    fi

    local tex_name="$font-$name-$spec$exp_suffix"

    echo "otftotfm $exp_flag $common_flags $base_encoding_flags $*" \
      "-e '$kernfile' 'otf/$font-$name.otf' '$tex_name'" >>"$script_file"
  done
}

make_ligkern_options() {
  if [ -e "kerning/$1.kern" ]
  then
    echo $(
      sed -n -e "s/#$2#//gp" "kerning/$1.kern" | 
      awk '{print "--ligkern '\''"$3" "$4" "$5"'\''"}' 
    )
  fi
}

get_flags() {
  case $2 in
      lf) flags="-flnum -fpnum";;
     osf) flags="-fonum -fpnum";;
     tlf) flags="-flnum -ftnum";;
    tosf) flags="-fonum -ftnum";;
  esac
  flags="$flags $quote_flags $(make_ligkern_options "$1" "$2")"
}
get_ts_flags() {
  case $1 in
    *It*) ts_flags="$ts_it_compat_flags";;
       *) ts_flags="$ts_rm_compat_flags";;
  esac
  case $2 in
      lf) ts_flags="$ts_flags -fpnum --subs-filter='<Number>' -fonum --subs-filter='!<Number>' -flnum";;
     osf) ts_flags="$ts_flags -fpnum --subs-filter='<Number>' -flnum --subs-filter='!<Number>' -fonum";;
     tlf) ts_flags="$ts_flags -ftnum --subs-filter='<Number>' -fonum --subs-filter='!<Number>' -flnum";;
    tosf) ts_flags="$ts_flags -ftnum --subs-filter='<Number>' -flnum --subs-filter='!<Number>' -fonum";;
  esac
}
get_sc_flags() {
  case $1 in
      lf) sc_flags="$noliga -flnum -fpnum --subs-filter='<Letter>' -fsmcp";;
     osf) sc_flags="$noliga -fonum -fpnum -fsmcp";;
     tlf) sc_flags="$noliga -flnum -ftnum --subs-filter='<Letter>' -fsmcp";;
    tosf) sc_flags="$noliga -fonum -ftnum -fsmcp";;
  esac
}
get_sc_ts_flags() {
  case $1 in
    *It*) sc_ts_flags="ts_it_compat_flags";;
       *) sc_ts_flags="ts_rm_compat_flags";;
  esac
  case $2 in
      lf) sc_ts_flags="$sc_ts_flags -fpnum"
          sc_ts_flags="$sc_ts_flags --subs-filter='<Number>'  -fonum"
          sc_ts_flags="$sc_ts_flags --subs-filter='!<Number>' -flnum"
          sc_ts_flags="$sc_ts_flags --subs-filter='<Letter>'  -fsmcp";;
     osf) sc_ts_flags="$sc_ts_flags -fpnum -fsmcp"
          sc_ts_flags="$sc_ts_flags --subs-filter='<Number>'  -flnum"
          sc_ts_flags="$sc_ts_flags --subs-filter=!'<Number>' -fonum";;
     tlf) sc_ts_flags="$sc_ts_flags -ftnum"
          sc_ts_flags="$sc_ts_flags --subs-filter='<Number>'  -fonum"
          sc_ts_flags="$sc_ts_flags --subs-filter='!<Number>' -flnum"
          sc_ts_flags="$sc_ts_flags --subs-filter='<Letter>'  -fsmcp";;
    tosf) sc_ts_flags="$sc_ts_flags -ftnum -fsmcp"
          sc_ts_flags="$sc_ts_flags --subs-filter='<Number>'  -flnum"
          sc_ts_flags="$sc_ts_flags --subs-filter='!<Number>' -fonum";;
  esac
}
get_it_ot1_flags() {
  case $1 in
    *It*) it_ot1_flags="--unicoding 'dollar =: sterling'";;
    *)    it_ot1_flags="";;
  esac
}
get_lgr_flags() {
  case $1 in
    *It*) lgr_flags="--unicoding 'kappa =: kappasymbolgreek kappa' --unicoding 'theta =: theta1 theta' --unicoding 'space_dotbelowcomb_Iota =: uniE261' --unicoding 'space_dotbelowcomb_iota =: uniE261' --unicoding 'space_dotbelowcomb_upsilon =: uniE261' --unicoding 'space_dotbelowcomb_lambda =: uniE261' --unicoding 'space_dotbelowcomb_beta =: uniE261' --unicoding 'space_dotbelowcomb_zeta =: uniE261' --unicoding 'space_dotbelowcomb_eta =: uniE261' --unicoding 'space_dotbelowcomb_Eta =: uniE261' --unicoding 'space_dotbelowcomb_Gamma =: uniE261' --unicoding 'space_dotbelowcomb_omicron =: uniE261' --unicoding 'space_dotbelowcomb_alpha =: uniE261' --unicoding 'space_dotbelowcomb_alphasub =: uniE261' --unicoding 'space_dotbelowcomb_omegasub =: uniE261' --unicoding 'space_dotbelowcomb_etasub =: uniE261' --unicoding 'space_dotbelowcomb_epsilon =: uniE261' --unicoding 'space_dotbelowcomb_psi =: uniE261' --unicoding 'space_dotbelowcomb_gamma =: uniE261' --unicoding 'space_dotbelowcomb_Mu =: uniE261' --unicoding 'space_dotbelowcomb_Psi =: uniE261'";;
    *)    lgr_flags="--unicoding 'space_dotbelowcomb_Iota =: uniE188' --unicoding 'space_dotbelowcomb_iota =: uniE188' --unicoding 'space_dotbelowcomb_upsilon =: uniE188' --unicoding 'space_dotbelowcomb_lambda =: uniE188' --unicoding 'space_dotbelowcomb_beta =: uniE188' --unicoding 'space_dotbelowcomb_zeta =: uniE188' --unicoding 'space_dotbelowcomb_eta =: uniE188' --unicoding 'space_dotbelowcomb_Eta =: uniE188' --unicoding 'space_dotbelowcomb_Gamma =: uniE188' --unicoding 'space_dotbelowcomb_omicron =: uniE188' --unicoding 'space_dotbelowcomb_alpha =: uniE188' --unicoding 'space_dotbelowcomb_alphasub =: uniE188' --unicoding 'space_dotbelowcomb_omegasub =: uniE188' --unicoding 'space_dotbelowcomb_etasub =: uniE188' --unicoding 'space_dotbelowcomb_epsilon =: uniE188' --unicoding 'space_dotbelowcomb_psi =: uniE188' --unicoding 'space_dotbelowcomb_gamma =: uniE188' --unicoding 'space_dotbelowcomb_Mu =: uniE188' --unicoding 'space_dotbelowcomb_Psi =: uniE188'";;
  esac
}

make_normal_metrics() {

  get_flags        "$1" "$2"
  get_ts_flags     "$1" "$2"
  get_sc_flags     "$2"
  get_sc_ts_flags  "$1" "$2"
  get_it_ot1_flags "$1"
  get_lgr_flags    "$1"

  make_tfm   "$1" t1  $2-t1  "-fliga $flags"
  make_tfm   "$1" ot1 $2-ot1 "-fliga $it_ot1_flags $flags"
  make_tfm   "$1" ly1 $2-ly1 "-fliga $flags"
  make_tfm   "$1" ts1 $2-ts1 "       $ts_flags"

  if $create_greek
  then
    make_tfm "$1" lgr $2-lgr "-sgrek $lgr_flags $greek_flags $flags"
    make_tfm "$1" lgi $2-lgi "-sgrek $lgr_flags $greek_flags $flags"
  fi
  if $create_cyrillic
  then
    make_tfm "$1" t2a $2-t2a "-scyrl $flags"
    make_tfm "$1" t2b $2-t2b "-scyrl $flags"
    make_tfm "$1" t2c $2-t2c "-scyrl $flags"
    make_tfm "$1" x2  $2-x2  "-scyrl $flags"
    make_tfm "$1" ot2 $2-ot2 "-scyrl $flags"
  fi
  if $create_vietnamese
  then
    make_tfm "$1" t5   $2-t5 "       $flags"
  fi

  if $create_smallcaps
  then
    make_tfm     "$1" t1   $2-sc-t1     "       $sc_flags               --unicoding='germandbls =: SSsmall'"
    make_tfm     "$1" ot1  $2-sc-ot1    "       $sc_flags $it_ot1_flags --unicoding='germandbls =: SSsmall' --unicoding='dotlessj =: Jsmall'"
    make_tfm     "$1" ly1  $2-sc-ly1    "       $sc_flags               --unicoding='germandbls =: SSsmall' --unicoding='dotlessj =: Jsmall'"
    make_tfm     "$1" ts1  $2-sc-ts1    "       $sc_ts_flags"

    make_tfm     "$1" t1   $2-sc-l2-t1  "-L 80  $sc_flags               --space-factor=1.15 --unicoding='germandbls =: SSsmall'"
    make_tfm     "$1" ot1  $2-sc-l2-ot1 "-L 80  $sc_flags $it_ot1_flags --space-factor=1.15 --unicoding='germandbls =: SSsmall' --unicoding='dotlessj =: Jsmall'"
    make_tfm     "$1" ly1  $2-sc-l2-ly1 "-L 80  $sc_flags               --space-factor=1.15 --unicoding='germandbls =: SSsmall' --unicoding='dotlessj =: Jsmall'"
    make_tfm     "$1" ts1  $2-sc-l2-ts1 "-L 80  $sc_ts_flags            --space-factor=1.15"

    if $create_sc_grekcyrl
    then
      if $create_greek
      then
        make_tfm "$1" lgr  $2-sc-lgr    "       $sc_flags               -sgrek $lgr_flags $greek_flags"
        make_tfm "$1" lgi  $2-sc-lgi    "       $sc_flags               -sgrek $lgr_flags $greek_flags"
        make_tfm "$1" lgr  $2-sc-l2-lgr "-L 80  $sc_flags               -sgrek $lgr_flags $greek_flags --space-factor=1.15 "
        make_tfm "$1" lgi  $2-sc-l2-lgi "-L 80  $sc_flags               -sgrek $lgr_flags $greek_flags --space-factor=1.15"
      fi
      if $create_cyrillic
      then
        make_tfm "$1" t2a  $2-sc-t2a    "       $sc_flags               -scyrl"
        make_tfm "$1" t2b  $2-sc-t2b    "       $sc_flags               -scyrl"
        make_tfm "$1" t2c  $2-sc-t2c    "       $sc_flags               -scyrl"
        make_tfm "$1" x2   $2-sc-x2     "       $sc_flags               -scyrl"
        make_tfm "$1" ot2  $2-sc-ot2    "       $sc_flags               -scyrl"
        make_tfm "$1" t2a  $2-sc-l2-t2a "-L 80  $sc_flags               -scyrl --space-factor=1.15"
        make_tfm "$1" t2b  $2-sc-l2-t2b "-L 80  $sc_flags               -scyrl --space-factor=1.15"
        make_tfm "$1" t2c  $2-sc-l2-t2c "-L 80  $sc_flags               -scyrl --space-factor=1.15"
        make_tfm "$1" x2   $2-sc-l2-x2  "-L 80  $sc_flags               -scyrl --space-factor=1.15"
        make_tfm "$1" ot2  $2-sc-l2-ot2 "-L 80  $sc_flags               -scyrl --space-factor=1.15"
      fi
    fi

    if $create_vietnamese
    then
      make_tfm   "$1" t5   $2-sc-t5     "       $sc_flags"
      make_tfm   "$1" t5   $2-sc-l2-t5  "-L 80  $sc_flags               --space-factor=1.15"
    fi
  fi
}

make_spread_metrics() {

  get_flags        "$1" "$2"
  get_ts_flags     "$1" "$2"
  get_sc_flags     "$2"
  get_sc_ts_flags  "$1" "$2"
  get_it_ot1_flags "$1"
  get_lgr_flags    "$1"

  make_tfm "$1" t1     $2-l1-t1     "-L 40        $flags"
  make_tfm "$1" ot1    $2-l1-ot1    "-L 40        $it_ot1_flags $flags"
  make_tfm "$1" ly1    $2-l1-ly1    "-L 40        $flags"
  make_tfm "$1" ts1    $2-l1-ts1    "-L 40        $ts_flags"

  if $create_greek
  then
    make_tfm "$1" lgr  $2-l1-lgr    "-L 40 -sgrek $lgr_flags $greek_flags $flags"
    make_tfm "$1" lgi  $2-l1-lgi    "-L 40 -sgrek $lgr_flags $greek_flags $flags"
  fi
  if $create_cyrillic
  then
    make_tfm "$1" t2a  $2-l1-t2a    "-L 40 -scyrl $flags"
    make_tfm "$1" t2b  $2-l1-t2b    "-L 40 -scyrl $flags"
    make_tfm "$1" t2c  $2-l1-t2c    "-L 40 -scyrl $flags"
    make_tfm "$1" x2   $2-l1-x2     "-L 40 -scyrl $flags"
    make_tfm "$1" ot2  $2-l1-ot2    "-L 40 -scyrl $flags"
  fi
  if $create_vietnamese
  then
    make_tfm "$1" t5   $2-l1-t5     "-L 40        $flags"
  fi

  if $create_smallcaps
  then
    make_tfm "$1" t1     $2-sc-l1-t1  "-L 40 $sc_flags               --unicoding='germandbls =: SSsmall'"
    make_tfm "$1" ot1    $2-sc-l1-ot1 "-L 40 $sc_flags $it_ot1_flags --unicoding='germandbls =: SSsmall' --unicoding='dotlessj =: Jsmall'"
    make_tfm "$1" ly1    $2-sc-l1-ly1 "-L 40 $sc_flags               --unicoding='germandbls =: SSsmall' --unicoding='dotlessj =: Jsmall'"
    make_tfm "$1" ts1    $2-sc-l1-ts1 "-L 40 $sc_ts_flags"

    if $create_sc_grekcyrl
    then
      if $create_greek
      then
        make_tfm "$1" lgr  $2-sc-l1-lgr "-L 40 $sc_flags -sgrek $lgr_flags $greek_flags"
        make_tfm "$1" lgi  $2-sc-l1-lgi "-L 40 $sc_flags -sgrek $lgr_flags $greek_flags"
      fi
      if $create_cyrillic
      then
        make_tfm "$1" t2a  $2-sc-l1-t2a "-L 40 $sc_flags -scyrl"
        make_tfm "$1" t2b  $2-sc-l1-t2b "-L 40 $sc_flags -scyrl"
        make_tfm "$1" t2c  $2-sc-l1-t2c "-L 40 $sc_flags -scyrl"
        make_tfm "$1" x2   $2-sc-l1-x2  "-L 40 $sc_flags -scyrl"
        make_tfm "$1" ot2  $2-sc-l1-ot2 "-L 40 $sc_flags -scyrl"
      fi
    fi

    if $create_vietnamese
    then
      make_tfm "$1" t5   $2-sc-l1-t5  "-L 40 $sc_flags"
    fi
  fi
}

make_integrals() {

  if [ -e "pfb/$font-$1.pfb" ]
  then
    progress -n "Processing font $font-$1 ..."

    make_tfm "$1" integral integral
    make_tfm "$1" integral integral-cn1 "-E 0.85"
    make_tfm "$1" integral integral-cn2 "-E 0.75 -S 0.04"

    progress " done."
  fi
}

make_metrics() {

  if [ -e "pfb/$font-$1.pfb" ]
  then
    progress -n "Processing font $font-$1 ..."

    make_base_fonts "$1"

    make_normal_metrics "$1" lf
    make_normal_metrics "$1" tlf
    make_normal_metrics "$1" osf
    make_normal_metrics "$1" tosf

    make_tfm "$1" oml     tosf-oml    "-L 40 --math-spacing=255 --subs-filter='!uniF638' -fonum -ftnum $oml_flags"
    make_tfm "$1" extra-u extra-u     "$extra_flags"

    progress " done."
  fi
}

make_spaced_metrics() {

  if [ -e "pfb/$font-$1.pfb" ]
  then
    progress -n "Processing font $font-$1 ..."

    make_spread_metrics "$1" lf
    make_spread_metrics "$1" tlf
    make_spread_metrics "$1" osf
    make_spread_metrics "$1" tosf

    make_tfm "$1" oml tosf-l1-oml "-L 80 --math-spacing=255 --subs-filter='!uniF638' -fonum -ftnum $oml_flags"

    progress " done."
  fi
}

make_swash_metrics() {

  if [ -e "pfb/$font-$1.pfb" ]
  then
    progress -n "Processing font $font-$1 ..."

    get_it_ot1_flags "$1"
    local swash="--include-alternates '*.swash' -faalt"

    make_tfm "$1" t1  lf-swash-t1    "-fliga -flnum -fpnum $swash"
    make_tfm "$1" t1  osf-swash-t1   "-fliga -fonum -fpnum $swash"
    make_tfm "$1" t1  tlf-swash-t1   "-fliga -flnum -ftnum $swash"
    make_tfm "$1" t1  tosf-swash-t1  "-fliga -fonum -ftnum $swash"
    make_tfm "$1" ot1 lf-swash-ot1   "-fliga -flnum -fpnum $it_ot1_flags $swash"
    make_tfm "$1" ot1 osf-swash-ot1  "-fliga -fonum -fpnum $it_ot1_flags $swash"
    make_tfm "$1" ot1 tlf-swash-ot1  "-fliga -flnum -ftnum $it_ot1_flags $swash"
    make_tfm "$1" ot1 tosf-swash-ot1 "-fliga -fonum -ftnum $it_ot1_flags $swash"
    make_tfm "$1" ly1 lf-swash-ly1   "-fliga -flnum -fpnum $swash"
    make_tfm "$1" ly1 osf-swash-ly1  "-fliga -fonum -fpnum $swash"
    make_tfm "$1" ly1 tlf-swash-ly1  "-fliga -flnum -ftnum $swash"
    make_tfm "$1" ly1 tosf-swash-ly1 "-fliga -fonum -ftnum $swash"

    if $create_vietnamese
    then
      make_tfm "$1" t5  lf-swash-t5    "-flnum -fpnum $swash"
      make_tfm "$1" t5  osf-swash-t5   "-fonum -fpnum $swash"
      make_tfm "$1" t5  tlf-swash-t5   "-flnum -ftnum $swash"
      make_tfm "$1" t5  tosf-swash-t5  "-fonum -ftnum $swash"
    fi

    progress " done."
  fi
}

make_spaced_swash_metrics() {

  if [ -e "pfb/$font-$1.pfb" ]
  then
    progress -n "Processing font $font-$1 ..."

    get_it_ot1_flags "$1"
    local swash="--include-alternates '*.swash' -faalt"

    make_tfm "$1" t1  lf-swash-l1-t1    "-L 40 -flnum -fpnum $swash"
    make_tfm "$1" t1  osf-swash-l1-t1   "-L 40 -fonum -fpnum $swash"
    make_tfm "$1" t1  tlf-swash-l1-t1   "-L 40 -flnum -ftnum $swash"
    make_tfm "$1" t1  tosf-swash-l1-t1  "-L 40 -fonum -ftnum $swash"
    make_tfm "$1" ot1 lf-swash-l1-ot1   "-L 40 -flnum -fpnum $it_ot1_flags $swash"
    make_tfm "$1" ot1 osf-swash-l1-ot1  "-L 40 -fonum -fpnum $it_ot1_flags $swash"
    make_tfm "$1" ot1 tlf-swash-l1-ot1  "-L 40 -flnum -ftnum $it_ot1_flags $swash"
    make_tfm "$1" ot1 tosf-swash-l1-ot1 "-L 40 -fonum -ftnum $it_ot1_flags $swash"
    make_tfm "$1" ly1 lf-swash-l1-ly1   "-L 40 -flnum -fpnum $swash"
    make_tfm "$1" ly1 osf-swash-l1-ly1  "-L 40 -fonum -fpnum $swash"
    make_tfm "$1" ly1 tlf-swash-l1-ly1  "-L 40 -flnum -ftnum $swash"
    make_tfm "$1" ly1 tosf-swash-l1-ly1 "-L 40 -fonum -ftnum $swash"

    if $create_vietnamese
    then
      make_tfm "$1" t5  lf-swash-l1-t5    "-L 40 -flnum -fpnum $swash"
      make_tfm "$1" t5  osf-swash-l1-t5   "-L 40 -fonum -fpnum $swash"
      make_tfm "$1" t5  tlf-swash-l1-t5   "-L 40 -flnum -ftnum $swash"
      make_tfm "$1" t5  tosf-swash-l1-t5  "-L 40 -fonum -ftnum $swash"
    fi

    progress " done."
  fi
}

make_series() {

  local sub

  for sub in "" Capt Disp Subh
  do
    if [[ $1$sub = "" ]]
    then
      make_enckern Regular
      make_metrics Regular
    else
      make_enckern "$1$sub"
      make_metrics "$1$sub"
    fi
  done

  make_spaced_metrics "$1Capt"

  if [[ $1 = "" ]]
  then
    make_spaced_metrics Regular
  else
    make_spaced_metrics "$1"
  fi
}

make_additional_italic() {

  local sub

  for sub in "" Capt Disp Subh
  do
    if $create_swash
    then
      make_swash_metrics "$1$sub"
    fi
    make_integrals     "$1$sub"
  done
  if $create_swash
  then
    make_spaced_swash_metrics "$1"
    make_spaced_swash_metrics "$1Capt"
  fi
}

# Fix map lines referring to .otf fonts (resulting from otftotfm not finding
# the .pfb because they have not yet been installed: Happens either before the
# first installation if otftotfm is compiled with kpathsea support or in any
# case if it's compiled without.)
fix_map() {
    sed -e 's/\.otf$/.pfb/' | grep -v "base "
}

# Ok, let's start.

{
  make_base_encodings

  # We first create shell scripts with the actual otftotfm calls.

  echo "#!/bin/bash" >maketfm.tmp
  echo "#!/bin/bash" >maketfm-expanded.tmp

  for weight in Light "" Medium Semibold Bold Black
  do
    for width in Cond SemiCn "" SemiExt
    do
      make_series             "$weight$width"
      make_series             "$weight${width}It"

      make_additional_italic  "$weight${width}It"
    done
  done

  # Then we execute and delete them.

  tr "\177" " " <maketfm.tmp >maketfm.tmp2
  tr "\177" " " <maketfm-expanded.tmp >maketfm-expanded.tmp2

  . maketfm.tmp2
  . maketfm-expanded.tmp2
} | fix_map

rm maketfm.tmp maketfm.tmp2 maketfm-expanded.tmp maketfm-expanded.tmp2
